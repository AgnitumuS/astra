/*
 * OpenSSL DES
 */

#include <string.h>
#include "des.h"

static const uint32_t des_skb[8][64] =
{{
    0x00000000L, 0x00000010L, 0x20000000L, 0x20000010L,
    0x00010000L, 0x00010010L, 0x20010000L, 0x20010010L,
    0x00000800L, 0x00000810L, 0x20000800L, 0x20000810L,
    0x00010800L, 0x00010810L, 0x20010800L, 0x20010810L,
    0x00000020L, 0x00000030L, 0x20000020L, 0x20000030L,
    0x00010020L, 0x00010030L, 0x20010020L, 0x20010030L,
    0x00000820L, 0x00000830L, 0x20000820L, 0x20000830L,
    0x00010820L, 0x00010830L, 0x20010820L, 0x20010830L,
    0x00080000L, 0x00080010L, 0x20080000L, 0x20080010L,
    0x00090000L, 0x00090010L, 0x20090000L, 0x20090010L,
    0x00080800L, 0x00080810L, 0x20080800L, 0x20080810L,
    0x00090800L, 0x00090810L, 0x20090800L, 0x20090810L,
    0x00080020L, 0x00080030L, 0x20080020L, 0x20080030L,
    0x00090020L, 0x00090030L, 0x20090020L, 0x20090030L,
    0x00080820L, 0x00080830L, 0x20080820L, 0x20080830L,
    0x00090820L, 0x00090830L, 0x20090820L, 0x20090830L,
},{
    0x00000000L, 0x02000000L, 0x00002000L, 0x02002000L,
    0x00200000L, 0x02200000L, 0x00202000L, 0x02202000L,
    0x00000004L, 0x02000004L, 0x00002004L, 0x02002004L,
    0x00200004L, 0x02200004L, 0x00202004L, 0x02202004L,
    0x00000400L, 0x02000400L, 0x00002400L, 0x02002400L,
    0x00200400L, 0x02200400L, 0x00202400L, 0x02202400L,
    0x00000404L, 0x02000404L, 0x00002404L, 0x02002404L,
    0x00200404L, 0x02200404L, 0x00202404L, 0x02202404L,
    0x10000000L, 0x12000000L, 0x10002000L, 0x12002000L,
    0x10200000L, 0x12200000L, 0x10202000L, 0x12202000L,
    0x10000004L, 0x12000004L, 0x10002004L, 0x12002004L,
    0x10200004L, 0x12200004L, 0x10202004L, 0x12202004L,
    0x10000400L, 0x12000400L, 0x10002400L, 0x12002400L,
    0x10200400L, 0x12200400L, 0x10202400L, 0x12202400L,
    0x10000404L, 0x12000404L, 0x10002404L, 0x12002404L,
    0x10200404L, 0x12200404L, 0x10202404L, 0x12202404L,
},{
    0x00000000L, 0x00000001L, 0x00040000L, 0x00040001L,
    0x01000000L, 0x01000001L, 0x01040000L, 0x01040001L,
    0x00000002L, 0x00000003L, 0x00040002L, 0x00040003L,
    0x01000002L, 0x01000003L, 0x01040002L, 0x01040003L,
    0x00000200L, 0x00000201L, 0x00040200L, 0x00040201L,
    0x01000200L, 0x01000201L, 0x01040200L, 0x01040201L,
    0x00000202L, 0x00000203L, 0x00040202L, 0x00040203L,
    0x01000202L, 0x01000203L, 0x01040202L, 0x01040203L,
    0x08000000L, 0x08000001L, 0x08040000L, 0x08040001L,
    0x09000000L, 0x09000001L, 0x09040000L, 0x09040001L,
    0x08000002L, 0x08000003L, 0x08040002L, 0x08040003L,
    0x09000002L, 0x09000003L, 0x09040002L, 0x09040003L,
    0x08000200L, 0x08000201L, 0x08040200L, 0x08040201L,
    0x09000200L, 0x09000201L, 0x09040200L, 0x09040201L,
    0x08000202L, 0x08000203L, 0x08040202L, 0x08040203L,
    0x09000202L, 0x09000203L, 0x09040202L, 0x09040203L,
},{
    0x00000000L, 0x00100000L, 0x00000100L, 0x00100100L,
    0x00000008L, 0x00100008L, 0x00000108L, 0x00100108L,
    0x00001000L, 0x00101000L, 0x00001100L, 0x00101100L,
    0x00001008L, 0x00101008L, 0x00001108L, 0x00101108L,
    0x04000000L, 0x04100000L, 0x04000100L, 0x04100100L,
    0x04000008L, 0x04100008L, 0x04000108L, 0x04100108L,
    0x04001000L, 0x04101000L, 0x04001100L, 0x04101100L,
    0x04001008L, 0x04101008L, 0x04001108L, 0x04101108L,
    0x00020000L, 0x00120000L, 0x00020100L, 0x00120100L,
    0x00020008L, 0x00120008L, 0x00020108L, 0x00120108L,
    0x00021000L, 0x00121000L, 0x00021100L, 0x00121100L,
    0x00021008L, 0x00121008L, 0x00021108L, 0x00121108L,
    0x04020000L, 0x04120000L, 0x04020100L, 0x04120100L,
    0x04020008L, 0x04120008L, 0x04020108L, 0x04120108L,
    0x04021000L, 0x04121000L, 0x04021100L, 0x04121100L,
    0x04021008L, 0x04121008L, 0x04021108L, 0x04121108L,
},{
    0x00000000L, 0x10000000L, 0x00010000L, 0x10010000L,
    0x00000004L, 0x10000004L, 0x00010004L, 0x10010004L,
    0x20000000L, 0x30000000L, 0x20010000L, 0x30010000L,
    0x20000004L, 0x30000004L, 0x20010004L, 0x30010004L,
    0x00100000L, 0x10100000L, 0x00110000L, 0x10110000L,
    0x00100004L, 0x10100004L, 0x00110004L, 0x10110004L,
    0x20100000L, 0x30100000L, 0x20110000L, 0x30110000L,
    0x20100004L, 0x30100004L, 0x20110004L, 0x30110004L,
    0x00001000L, 0x10001000L, 0x00011000L, 0x10011000L,
    0x00001004L, 0x10001004L, 0x00011004L, 0x10011004L,
    0x20001000L, 0x30001000L, 0x20011000L, 0x30011000L,
    0x20001004L, 0x30001004L, 0x20011004L, 0x30011004L,
    0x00101000L, 0x10101000L, 0x00111000L, 0x10111000L,
    0x00101004L, 0x10101004L, 0x00111004L, 0x10111004L,
    0x20101000L, 0x30101000L, 0x20111000L, 0x30111000L,
    0x20101004L, 0x30101004L, 0x20111004L, 0x30111004L,
},{
    0x00000000L, 0x08000000L, 0x00000008L, 0x08000008L,
    0x00000400L, 0x08000400L, 0x00000408L, 0x08000408L,
    0x00020000L, 0x08020000L, 0x00020008L, 0x08020008L,
    0x00020400L, 0x08020400L, 0x00020408L, 0x08020408L,
    0x00000001L, 0x08000001L, 0x00000009L, 0x08000009L,
    0x00000401L, 0x08000401L, 0x00000409L, 0x08000409L,
    0x00020001L, 0x08020001L, 0x00020009L, 0x08020009L,
    0x00020401L, 0x08020401L, 0x00020409L, 0x08020409L,
    0x02000000L, 0x0A000000L, 0x02000008L, 0x0A000008L,
    0x02000400L, 0x0A000400L, 0x02000408L, 0x0A000408L,
    0x02020000L, 0x0A020000L, 0x02020008L, 0x0A020008L,
    0x02020400L, 0x0A020400L, 0x02020408L, 0x0A020408L,
    0x02000001L, 0x0A000001L, 0x02000009L, 0x0A000009L,
    0x02000401L, 0x0A000401L, 0x02000409L, 0x0A000409L,
    0x02020001L, 0x0A020001L, 0x02020009L, 0x0A020009L,
    0x02020401L, 0x0A020401L, 0x02020409L, 0x0A020409L,
},{
    0x00000000L, 0x00000100L, 0x00080000L, 0x00080100L,
    0x01000000L, 0x01000100L, 0x01080000L, 0x01080100L,
    0x00000010L, 0x00000110L, 0x00080010L, 0x00080110L,
    0x01000010L, 0x01000110L, 0x01080010L, 0x01080110L,
    0x00200000L, 0x00200100L, 0x00280000L, 0x00280100L,
    0x01200000L, 0x01200100L, 0x01280000L, 0x01280100L,
    0x00200010L, 0x00200110L, 0x00280010L, 0x00280110L,
    0x01200010L, 0x01200110L, 0x01280010L, 0x01280110L,
    0x00000200L, 0x00000300L, 0x00080200L, 0x00080300L,
    0x01000200L, 0x01000300L, 0x01080200L, 0x01080300L,
    0x00000210L, 0x00000310L, 0x00080210L, 0x00080310L,
    0x01000210L, 0x01000310L, 0x01080210L, 0x01080310L,
    0x00200200L, 0x00200300L, 0x00280200L, 0x00280300L,
    0x01200200L, 0x01200300L, 0x01280200L, 0x01280300L,
    0x00200210L, 0x00200310L, 0x00280210L, 0x00280310L,
    0x01200210L, 0x01200310L, 0x01280210L, 0x01280310L,
},{
    0x00000000L, 0x04000000L, 0x00040000L, 0x04040000L,
    0x00000002L, 0x04000002L, 0x00040002L, 0x04040002L,
    0x00002000L, 0x04002000L, 0x00042000L, 0x04042000L,
    0x00002002L, 0x04002002L, 0x00042002L, 0x04042002L,
    0x00000020L, 0x04000020L, 0x00040020L, 0x04040020L,
    0x00000022L, 0x04000022L, 0x00040022L, 0x04040022L,
    0x00002020L, 0x04002020L, 0x00042020L, 0x04042020L,
    0x00002022L, 0x04002022L, 0x00042022L, 0x04042022L,
    0x00000800L, 0x04000800L, 0x00040800L, 0x04040800L,
    0x00000802L, 0x04000802L, 0x00040802L, 0x04040802L,
    0x00002800L, 0x04002800L, 0x00042800L, 0x04042800L,
    0x00002802L, 0x04002802L, 0x00042802L, 0x04042802L,
    0x00000820L, 0x04000820L, 0x00040820L, 0x04040820L,
    0x00000822L, 0x04000822L, 0x00040822L, 0x04040822L,
    0x00002820L, 0x04002820L, 0x00042820L, 0x04042820L,
    0x00002822L, 0x04002822L, 0x00042822L, 0x04042822L,
}};

static const uint32_t des_sp[8][64] =
{{
    0x02080800L, 0x00080000L, 0x02000002L, 0x02080802L,
    0x02000000L, 0x00080802L, 0x00080002L, 0x02000002L,
    0x00080802L, 0x02080800L, 0x02080000L, 0x00000802L,
    0x02000802L, 0x02000000L, 0x00000000L, 0x00080002L,
    0x00080000L, 0x00000002L, 0x02000800L, 0x00080800L,
    0x02080802L, 0x02080000L, 0x00000802L, 0x02000800L,
    0x00000002L, 0x00000800L, 0x00080800L, 0x02080002L,
    0x00000800L, 0x02000802L, 0x02080002L, 0x00000000L,
    0x00000000L, 0x02080802L, 0x02000800L, 0x00080002L,
    0x02080800L, 0x00080000L, 0x00000802L, 0x02000800L,
    0x02080002L, 0x00000800L, 0x00080800L, 0x02000002L,
    0x00080802L, 0x00000002L, 0x02000002L, 0x02080000L,
    0x02080802L, 0x00080800L, 0x02080000L, 0x02000802L,
    0x02000000L, 0x00000802L, 0x00080002L, 0x00000000L,
    0x00080000L, 0x02000000L, 0x02000802L, 0x02080800L,
    0x00000002L, 0x02080002L, 0x00000800L, 0x00080802L,
},{
    0x40108010L, 0x00000000L, 0x00108000L, 0x40100000L,
    0x40000010L, 0x00008010L, 0x40008000L, 0x00108000L,
    0x00008000L, 0x40100010L, 0x00000010L, 0x40008000L,
    0x00100010L, 0x40108000L, 0x40100000L, 0x00000010L,
    0x00100000L, 0x40008010L, 0x40100010L, 0x00008000L,
    0x00108010L, 0x40000000L, 0x00000000L, 0x00100010L,
    0x40008010L, 0x00108010L, 0x40108000L, 0x40000010L,
    0x40000000L, 0x00100000L, 0x00008010L, 0x40108010L,
    0x00100010L, 0x40108000L, 0x40008000L, 0x00108010L,
    0x40108010L, 0x00100010L, 0x40000010L, 0x00000000L,
    0x40000000L, 0x00008010L, 0x00100000L, 0x40100010L,
    0x00008000L, 0x40000000L, 0x00108010L, 0x40008010L,
    0x40108000L, 0x00008000L, 0x00000000L, 0x40000010L,
    0x00000010L, 0x40108010L, 0x00108000L, 0x40100000L,
    0x40100010L, 0x00100000L, 0x00008010L, 0x40008000L,
    0x40008010L, 0x00000010L, 0x40100000L, 0x00108000L,
},{
    0x04000001L, 0x04040100L, 0x00000100L, 0x04000101L,
    0x00040001L, 0x04000000L, 0x04000101L, 0x00040100L,
    0x04000100L, 0x00040000L, 0x04040000L, 0x00000001L,
    0x04040101L, 0x00000101L, 0x00000001L, 0x04040001L,
    0x00000000L, 0x00040001L, 0x04040100L, 0x00000100L,
    0x00000101L, 0x04040101L, 0x00040000L, 0x04000001L,
    0x04040001L, 0x04000100L, 0x00040101L, 0x04040000L,
    0x00040100L, 0x00000000L, 0x04000000L, 0x00040101L,
    0x04040100L, 0x00000100L, 0x00000001L, 0x00040000L,
    0x00000101L, 0x00040001L, 0x04040000L, 0x04000101L,
    0x00000000L, 0x04040100L, 0x00040100L, 0x04040001L,
    0x00040001L, 0x04000000L, 0x04040101L, 0x00000001L,
    0x00040101L, 0x04000001L, 0x04000000L, 0x04040101L,
    0x00040000L, 0x04000100L, 0x04000101L, 0x00040100L,
    0x04000100L, 0x00000000L, 0x04040001L, 0x00000101L,
    0x04000001L, 0x00040101L, 0x00000100L, 0x04040000L,
},{
    0x00401008L, 0x10001000L, 0x00000008L, 0x10401008L,
    0x00000000L, 0x10400000L, 0x10001008L, 0x00400008L,
    0x10401000L, 0x10000008L, 0x10000000L, 0x00001008L,
    0x10000008L, 0x00401008L, 0x00400000L, 0x10000000L,
    0x10400008L, 0x00401000L, 0x00001000L, 0x00000008L,
    0x00401000L, 0x10001008L, 0x10400000L, 0x00001000L,
    0x00001008L, 0x00000000L, 0x00400008L, 0x10401000L,
    0x10001000L, 0x10400008L, 0x10401008L, 0x00400000L,
    0x10400008L, 0x00001008L, 0x00400000L, 0x10000008L,
    0x00401000L, 0x10001000L, 0x00000008L, 0x10400000L,
    0x10001008L, 0x00000000L, 0x00001000L, 0x00400008L,
    0x00000000L, 0x10400008L, 0x10401000L, 0x00001000L,
    0x10000000L, 0x10401008L, 0x00401008L, 0x00400000L,
    0x10401008L, 0x00000008L, 0x10001000L, 0x00401008L,
    0x00400008L, 0x00401000L, 0x10400000L, 0x10001008L,
    0x00001008L, 0x10000000L, 0x10000008L, 0x10401000L,
},{
    0x08000000L, 0x00010000L, 0x00000400L, 0x08010420L,
    0x08010020L, 0x08000400L, 0x00010420L, 0x08010000L,
    0x00010000L, 0x00000020L, 0x08000020L, 0x00010400L,
    0x08000420L, 0x08010020L, 0x08010400L, 0x00000000L,
    0x00010400L, 0x08000000L, 0x00010020L, 0x00000420L,
    0x08000400L, 0x00010420L, 0x00000000L, 0x08000020L,
    0x00000020L, 0x08000420L, 0x08010420L, 0x00010020L,
    0x08010000L, 0x00000400L, 0x00000420L, 0x08010400L,
    0x08010400L, 0x08000420L, 0x00010020L, 0x08010000L,
    0x00010000L, 0x00000020L, 0x08000020L, 0x08000400L,
    0x08000000L, 0x00010400L, 0x08010420L, 0x00000000L,
    0x00010420L, 0x08000000L, 0x00000400L, 0x00010020L,
    0x08000420L, 0x00000400L, 0x00000000L, 0x08010420L,
    0x08010020L, 0x08010400L, 0x00000420L, 0x00010000L,
    0x00010400L, 0x08010020L, 0x08000400L, 0x00000420L,
    0x00000020L, 0x00010420L, 0x08010000L, 0x08000020L,
},{
    0x80000040L, 0x00200040L, 0x00000000L, 0x80202000L,
    0x00200040L, 0x00002000L, 0x80002040L, 0x00200000L,
    0x00002040L, 0x80202040L, 0x00202000L, 0x80000000L,
    0x80002000L, 0x80000040L, 0x80200000L, 0x00202040L,
    0x00200000L, 0x80002040L, 0x80200040L, 0x00000000L,
    0x00002000L, 0x00000040L, 0x80202000L, 0x80200040L,
    0x80202040L, 0x80200000L, 0x80000000L, 0x00002040L,
    0x00000040L, 0x00202000L, 0x00202040L, 0x80002000L,
    0x00002040L, 0x80000000L, 0x80002000L, 0x00202040L,
    0x80202000L, 0x00200040L, 0x00000000L, 0x80002000L,
    0x80000000L, 0x00002000L, 0x80200040L, 0x00200000L,
    0x00200040L, 0x80202040L, 0x00202000L, 0x00000040L,
    0x80202040L, 0x00202000L, 0x00200000L, 0x80002040L,
    0x80000040L, 0x80200000L, 0x00202040L, 0x00000000L,
    0x00002000L, 0x80000040L, 0x80002040L, 0x80202000L,
    0x80200000L, 0x00002040L, 0x00000040L, 0x80200040L,
},{
    0x00004000L, 0x00000200L, 0x01000200L, 0x01000004L,
    0x01004204L, 0x00004004L, 0x00004200L, 0x00000000L,
    0x01000000L, 0x01000204L, 0x00000204L, 0x01004000L,
    0x00000004L, 0x01004200L, 0x01004000L, 0x00000204L,
    0x01000204L, 0x00004000L, 0x00004004L, 0x01004204L,
    0x00000000L, 0x01000200L, 0x01000004L, 0x00004200L,
    0x01004004L, 0x00004204L, 0x01004200L, 0x00000004L,
    0x00004204L, 0x01004004L, 0x00000200L, 0x01000000L,
    0x00004204L, 0x01004000L, 0x01004004L, 0x00000204L,
    0x00004000L, 0x00000200L, 0x01000000L, 0x01004004L,
    0x01000204L, 0x00004204L, 0x00004200L, 0x00000000L,
    0x00000200L, 0x01000004L, 0x00000004L, 0x01000200L,
    0x00000000L, 0x01000204L, 0x01000200L, 0x00004200L,
    0x00000204L, 0x00004000L, 0x01004204L, 0x01000000L,
    0x01004200L, 0x00000004L, 0x00004004L, 0x01004204L,
    0x01000004L, 0x01004200L, 0x01004000L, 0x00004004L,
},{
    0x20800080L, 0x20820000L, 0x00020080L, 0x00000000L,
    0x20020000L, 0x00800080L, 0x20800000L, 0x20820080L,
    0x00000080L, 0x20000000L, 0x00820000L, 0x00020080L,
    0x00820080L, 0x20020080L, 0x20000080L, 0x20800000L,
    0x00020000L, 0x00820080L, 0x00800080L, 0x20020000L,
    0x20820080L, 0x20000080L, 0x00000000L, 0x00820000L,
    0x20000000L, 0x00800000L, 0x20020080L, 0x20800080L,
    0x00800000L, 0x00020000L, 0x20820000L, 0x00000080L,
    0x00800000L, 0x00020000L, 0x20000080L, 0x20820080L,
    0x00020080L, 0x20000000L, 0x00000000L, 0x00820000L,
    0x20800080L, 0x20020080L, 0x20020000L, 0x00800080L,
    0x20820000L, 0x00000080L, 0x00800080L, 0x20020000L,
    0x20820080L, 0x00800000L, 0x20800000L, 0x20000080L,
    0x00820000L, 0x00020080L, 0x20020080L, 0x20800000L,
    0x00000080L, 0x20820000L, 0x00820080L, 0x00000000L,
    0x20000000L, 0x20800080L, 0x00020000L, 0x00820080L,
}};

/*
 *  ____  _____ ____
 * |  _ \| ____/ ___|
 * | | | |  _| \___ \
 * | |_| | |___ ___) |
 * |____/|_____|____/
 *
 */

# define c2l(c,l)                                                                               \
    {                                                                                           \
        const uint8_t *___c = c;                                                                \
        l = ((uint32_t)(___c[0]      )) |                                                       \
            ((uint32_t)(___c[1] <<  8)) |                                                       \
            ((uint32_t)(___c[2] << 16)) |                                                       \
            ((uint32_t)(___c[3] << 24));                                                        \
    }

#define l2c(l,c)                                                                                \
    {                                                                                           \
        const uint32_t ___l = l;                                                                \
        (c)[0] = (uint8_t)((___l      ) & 0xff);                                                \
        (c)[1] = (uint8_t)((___l >>  8) & 0xff);                                                \
        (c)[2] = (uint8_t)((___l >> 16) & 0xff);                                                \
        (c)[3] = (uint8_t)((___l >> 24) & 0xff);                                                \
    }

#define c2ln(c,l1,l2,n)                                                                         \
    {                                                                                           \
        const uint8_t *___c = (c) + (n);                                                        \
        l1 = l2 = 0;                                                                            \
        switch(n)                                                                               \
        {                                                                                       \
            case 8: l2 =((uint32_t)(___c[7])) << 24;                                            \
            case 7: l2|=((uint32_t)(___c[6])) << 16;                                            \
            case 6: l2|=((uint32_t)(___c[5])) <<  8;                                            \
            case 5: l2|=((uint32_t)(___c[4]));                                                  \
            case 4: l1 =((uint32_t)(___c[3])) << 24;                                            \
            case 3: l1|=((uint32_t)(___c[2])) << 16;                                            \
            case 2: l1|=((uint32_t)(___c[1])) <<  8;                                            \
            case 1: l1|=((uint32_t)(___c[0]));                                                  \
        }                                                                                       \
    }

#define l2cn(l1,l2,c,n)                                                                         \
    {                                                                                           \
        uint8_t *___c = (c) + (n);                                                              \
        switch(n)                                                                               \
        {                                                                                       \
            case 8: ___c[7] = (uint8_t)(((l2) >> 24) & 0xff);                                   \
            case 7: ___c[6] = (uint8_t)(((l2) >> 16) & 0xff);                                   \
            case 6: ___c[5] = (uint8_t)(((l2) >>  8) & 0xff);                                   \
            case 5: ___c[4] = (uint8_t)(((l2)      ) & 0xff);                                   \
            case 4: ___c[3] = (uint8_t)(((l1) >> 24) & 0xff);                                   \
            case 3: ___c[2] = (uint8_t)(((l1) >> 16) & 0xff);                                   \
            case 2: ___c[1] = (uint8_t)(((l1) >>  8) & 0xff);                                   \
            case 1: ___c[0] = (uint8_t)(((l1)      ) & 0xff);                                   \
        }                                                                                       \
    }

#define PERM_OP(a,b,t,n,m) ((t)=((((a)>>(n))^(b))&(m)), (b)^=(t), (a)^=((t)<<(n)))
#define HPERM_OP(a,t,n,m) ((t)=((((a)<<(16-(n)))^(a))&(m)), (a)=(a)^(t)^(t>>(16-(n))))

#define IP(l,r)                                                                                 \
    {                                                                                           \
        register uint32_t tt;                                                                   \
        PERM_OP(r,l,tt, 4,0x0f0f0f0fL);                                                         \
        PERM_OP(l,r,tt,16,0x0000ffffL);                                                         \
        PERM_OP(r,l,tt, 2,0x33333333L);                                                         \
        PERM_OP(l,r,tt, 8,0x00ff00ffL);                                                         \
        PERM_OP(r,l,tt, 1,0x55555555L);                                                         \
    }

# define FP(l,r)                                                                                \
    {                                                                                           \
        register uint32_t tt;                                                                   \
        PERM_OP(l,r,tt, 1,0x55555555L);                                                         \
        PERM_OP(r,l,tt, 8,0x00ff00ffL);                                                         \
        PERM_OP(l,r,tt, 2,0x33333333L);                                                         \
        PERM_OP(r,l,tt,16,0x0000ffffL);                                                         \
        PERM_OP(l,r,tt, 4,0x0f0f0f0fL);                                                         \
    }

#define ROTATE(a,n) (((a) >> (n)) + ((a) << (32 - (n))))

#define __DES_ENCRYPT(LL,R,S) {                                                                 \
    u = R ^ s[S    ];                                                                           \
    t = R ^ s[S + 1];                                                                           \
    t = ROTATE(t,4);                                                                            \
    LL ^=                                                                                       \
        des_sp[0][(u >>  2L) & 0x3f] ^                                                          \
        des_sp[2][(u >> 10L) & 0x3f] ^                                                          \
        des_sp[4][(u >> 18L) & 0x3f] ^                                                          \
        des_sp[6][(u >> 26L) & 0x3f] ^                                                          \
        des_sp[1][(t >>  2L) & 0x3f] ^                                                          \
        des_sp[3][(t >> 10L) & 0x3f] ^                                                          \
        des_sp[5][(t >> 18L) & 0x3f] ^                                                          \
        des_sp[7][(t >> 26L) & 0x3f] ; }

static void des_encrypt_block(uint32_t *data, des_ctx_t *ks, int enc)
{
    uint32_t l, r, t, u;
    register uint32_t *s;

    r = data[0];
    l = data[1];

    r = ROTATE(r, 29) & 0xffffffffL;
    l = ROTATE(l, 29) & 0xffffffffL;

    s = ks->ks->deslong; // for __DES_ENCRYPT

    if(enc)
    {
        for(int i = 0; i < 32; i += 4)
        {
            __DES_ENCRYPT(l, r, i + 0); /* 1 */
            __DES_ENCRYPT(r, l, i + 2); /* 2 */
        }
    }
    else
    {
        for(int i = 30; i > 0; i -= 4)
        {
            __DES_ENCRYPT(l, r, i - 0); /* 16 */
            __DES_ENCRYPT(r, l, i - 2); /* 15 */
        }
    }
    /* rotate and clear the top bits on machines with 8byte longs */
    data[0] = ROTATE(l, 3) & 0xffffffffL;
    data[1] = ROTATE(r, 3) & 0xffffffffL;
    l = r = t = u = 0;
}

static void des_encrypt_3(uint32_t *data, des_ctx_t *ks1, des_ctx_t *ks2, des_ctx_t *ks3)
{
    uint32_t l, r;

    l = data[0];
    r = data[1];
    IP(l, r);
    data[0] = l;
    data[1] = r;
    des_encrypt_block(data, ks1, 1);
    des_encrypt_block(data, ks2, 0);
    des_encrypt_block(data, ks3, 1);
    l = data[0];
    r = data[1];
    FP(r, l);
    data[0] = l;
    data[1] = r;
}

static void des_decrypt_3(uint32_t *data, des_ctx_t *ks1, des_ctx_t *ks2, des_ctx_t *ks3)
{
    uint32_t l, r;

    l = data[0];
    r = data[1];
    IP(l, r);
    data[0] = l;
    data[1] = r;
    des_encrypt_block(data, ks3, 0);
    des_encrypt_block(data, ks2, 1);
    des_encrypt_block(data, ks1, 0);
    l = data[0];
    r = data[1];
    FP(r, l);
    data[0] = l;
    data[1] = r;
}

void des_encrypt(const uint8_t *input, uint8_t *output, size_t length,
    des_ctx_t *ks1, des_ctx_t *ks2, des_ctx_t *ks3,
    uint8_t *ivec, int enc)
{
    register uint32_t tin0, tin1;
    register uint32_t tout0, tout1, xor0, xor1;
    register const unsigned char *in;
    uint8_t *out;
    register long l = length;
    uint32_t tin[2];

    in = input;
    out = output;

    if(enc)
    {
        c2l(&ivec[0], tout0);
        c2l(&ivec[4], tout1);

        for(l -= 8; l >= 0; l -= 8)
        {
            c2l(&in[0], tin0);
            c2l(&in[4], tin1);
            in += 8;

            tin0 ^= tout0;
            tin1 ^= tout1;

            tin[0] = tin0;
            tin[1] = tin1;
            des_encrypt_3(tin, ks1, ks2, ks3);
            tout0 = tin[0];
            tout1 = tin[1];

            l2c(tout0, &out[0]);
            l2c(tout1, &out[4]);
            out += 8;
        }
        if(l != -8)
        {
            c2ln(in, tin0, tin1, l + 8);
            tin0 ^= tout0;
            tin1 ^= tout1;

            tin[0] = tin0;
            tin[1] = tin1;
            des_encrypt_3(tin, ks1, ks2, ks3);
            tout0 = tin[0];
            tout1 = tin[1];

            l2c(tout0, &out[0]);
            l2c(tout1, &out[4]);
        }
        l2c(tout0, &ivec[0]);
        l2c(tout1, &ivec[4]);
    }
    else
    {
        register uint32_t t0, t1;

        c2l(&ivec[0], xor0);
        c2l(&ivec[4], xor1);
        for(l -= 8; l >= 0; l -= 8)
        {
            c2l(&in[0], tin0);
            c2l(&in[4], tin1);
            in += 8;

            t0 = tin0;
            t1 = tin1;

            tin[0] = tin0;
            tin[1] = tin1;
            des_decrypt_3(tin, ks1, ks2, ks3);
            tout0 = tin[0];
            tout1 = tin[1];

            tout0 ^= xor0;
            tout1 ^= xor1;
            l2c(tout0, &out[0]);
            l2c(tout1, &out[4]);
            out += 8;
            xor0 = t0;
            xor1 = t1;
        }
        if(l != -8)
        {
            c2l(&in[0], tin0);
            c2l(&in[4], tin1);

            t0 = tin0;
            t1 = tin1;

            tin[0] = tin0;
            tin[1] = tin1;
            des_decrypt_3(tin, ks1, ks2, ks3);
            tout0 = tin[0];
            tout1 = tin[1];

            tout0 ^= xor0;
            tout1 ^= xor1;
            l2cn(tout0, tout1, out, l + 8);
            xor0 = t0;
            xor1 = t1;
        }
        l2c(xor0, &ivec[0]);
        l2c(xor1, &ivec[4]);
    }
    tin0 = tin1 = tout0 = tout1 = xor0 = xor1 = 0;
    tin[0] = tin[1] = 0;
}

/*
 *  _____     _       _        ____  _____ ____
 * |_   _| __(_)_ __ | | ___  |  _ \| ____/ ___|
 *   | || '__| | '_ \| |/ _ \ | | | |  _| \___ \
 *   | || |  | | |_) | |  __/ | |_| | |___ ___) |
 *   |_||_|  |_| .__/|_|\___| |____/|_____|____/
 *             |_|
 */

void des_set_key(const uint8_t *key, des_ctx_t *schedule)
{
    static const int shifts2[16] = { 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0 };
    uint32_t c, d, t, s, t2;

    c2l(&key[0], c);
    c2l(&key[4], d);

    PERM_OP(d, c, t, 4, 0x0f0f0f0fL);
    HPERM_OP(c, t, -2, 0xcccc0000L);
    HPERM_OP(d, t, -2, 0xcccc0000L);
    PERM_OP(d, c, t, 1, 0x55555555L);
    PERM_OP(c, d, t, 8, 0x00ff00ffL);
    PERM_OP(d, c, t, 1, 0x55555555L);
    d = (((d & 0x000000ffL) << 16L) | (d & 0x0000ff00L) |
         ((d & 0x00ff0000L) >> 16L) | ((c & 0xf0000000L) >> 4L));
    c &= 0x0fffffffL;

    for(int i = 0; i < 16; i++)
    {
        if(shifts2[i])
        {
            c = ((c >> 2L) | (c << 26L));
            d = ((d >> 2L) | (d << 26L));
        }
        else
        {
            c = ((c >> 1L) | (c << 27L));
            d = ((d >> 1L) | (d << 27L));
        }
        c &= 0x0fffffffL;
        d &= 0x0fffffffL;
        /*
         * could be a few less shifts but I am to lazy at this point in time
         * to investigate
         */
        s = des_skb[0][(c) & 0x3f] |
            des_skb[1][((c >> 6L) & 0x03) | ((c >> 7L) & 0x3c)] |
            des_skb[2][((c >> 13L) & 0x0f) | ((c >> 14L) & 0x30)] |
            des_skb[3][((c >> 20L) & 0x01) | ((c >> 21L) & 0x06) |
                       ((c >> 22L) & 0x38)];
        t = des_skb[4][(d) & 0x3f] |
            des_skb[5][((d >> 7L) & 0x03) | ((d >> 8L) & 0x3c)] |
            des_skb[6][(d >> 15L) & 0x3f] |
            des_skb[7][((d >> 21L) & 0x0f) | ((d >> 22L) & 0x30)];

        /* table contained 0213 4657 */
        t2 = ((t << 16L) | (s & 0x0000ffffL)) & 0xffffffffL;
        schedule->ks[i].deslong[0] = ROTATE(t2, 30) & 0xffffffffL;

        t2 = ((s >> 16L) | (t & 0xffff0000L));
        schedule->ks[i].deslong[1] = ROTATE(t2, 26) & 0xffffffffL;
    }
}

static const uint8_t odd_parity[] =
{
  0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x07, 0x07, 0x08, 0x08, 0x0B, 0x0B, 0x0D, 0x0D, 0x0E, 0x0E,
  0x10, 0x10, 0x13, 0x13, 0x15, 0x15, 0x16, 0x16, 0x19, 0x19, 0x1A, 0x1A, 0x1C, 0x1C, 0x1F, 0x1F,
  0x20, 0x20, 0x23, 0x23, 0x25, 0x25, 0x26, 0x26, 0x29, 0x29, 0x2A, 0x2A, 0x2C, 0x2C, 0x2F, 0x2F,
  0x31, 0x31, 0x32, 0x32, 0x34, 0x34, 0x37, 0x37, 0x38, 0x38, 0x3B, 0x3B, 0x3D, 0x3D, 0x3E, 0x3E,
  0x40, 0x40, 0x43, 0x43, 0x45, 0x45, 0x46, 0x46, 0x49, 0x49, 0x4A, 0x4A, 0x4C, 0x4C, 0x4F, 0x4F,
  0x51, 0x51, 0x52, 0x52, 0x54, 0x54, 0x57, 0x57, 0x58, 0x58, 0x5B, 0x5B, 0x5D, 0x5D, 0x5E, 0x5E,
  0x61, 0x61, 0x62, 0x62, 0x64, 0x64, 0x67, 0x67, 0x68, 0x68, 0x6B, 0x6B, 0x6D, 0x6D, 0x6E, 0x6E,
  0x70, 0x70, 0x73, 0x73, 0x75, 0x75, 0x76, 0x76, 0x79, 0x79, 0x7A, 0x7A, 0x7C, 0x7C, 0x7F, 0x7F,
  0x80, 0x80, 0x83, 0x83, 0x85, 0x85, 0x86, 0x86, 0x89, 0x89, 0x8A, 0x8A, 0x8C, 0x8C, 0x8F, 0x8F,
  0x91, 0x91, 0x92, 0x92, 0x94, 0x94, 0x97, 0x97, 0x98, 0x98, 0x9B, 0x9B, 0x9D, 0x9D, 0x9E, 0x9E,
  0xA1, 0xA1, 0xA2, 0xA2, 0xA4, 0xA4, 0xA7, 0xA7, 0xA8, 0xA8, 0xAB, 0xAB, 0xAD, 0xAD, 0xAE, 0xAE,
  0xB0, 0xB0, 0xB3, 0xB3, 0xB5, 0xB5, 0xB6, 0xB6, 0xB9, 0xB9, 0xBA, 0xBA, 0xBC, 0xBC, 0xBF, 0xBF,
  0xC1, 0xC1, 0xC2, 0xC2, 0xC4, 0xC4, 0xC7, 0xC7, 0xC8, 0xC8, 0xCB, 0xCB, 0xCD, 0xCD, 0xCE, 0xCE,
  0xD0, 0xD0, 0xD3, 0xD3, 0xD5, 0xD5, 0xD6, 0xD6, 0xD9, 0xD9, 0xDA, 0xDA, 0xDC, 0xDC, 0xDF, 0xDF,
  0xE0, 0xE0, 0xE3, 0xE3, 0xE5, 0xE5, 0xE6, 0xE6, 0xE9, 0xE9, 0xEA, 0xEA, 0xEC, 0xEC, 0xEF, 0xEF,
  0xF1, 0xF1, 0xF2, 0xF2, 0xF4, 0xF4, 0xF7, 0xF7, 0xF8, 0xF8, 0xFB, 0xFB, 0xFD, 0xFD, 0xFE, 0xFE
};

void triple_des_set_key(const uint8_t *key, const char *pass, size_t key_size,
    des_ctx_t *ks1, des_ctx_t *ks2)
{
    uint8_t tmp_key[14];
    memcpy(tmp_key, key, sizeof(tmp_key));

    // set key
    for(size_t i = 0; i < key_size; ++i)
        tmp_key[i % sizeof(tmp_key)] ^= (uint8_t)pass[i];

    uint8_t triple_des_key[16];
    triple_des_key[0] = tmp_key[0] & 0xfe;
    triple_des_key[1] = ((tmp_key[0] << 7) | (tmp_key[1] >> 1)) & 0xfe;
    triple_des_key[2] = ((tmp_key[1] << 6) | (tmp_key[2] >> 2)) & 0xfe;
    triple_des_key[3] = ((tmp_key[2] << 5) | (tmp_key[3] >> 3)) & 0xfe;
    triple_des_key[4] = ((tmp_key[3] << 4) | (tmp_key[4] >> 4)) & 0xfe;
    triple_des_key[5] = ((tmp_key[4] << 3) | (tmp_key[5] >> 5)) & 0xfe;
    triple_des_key[6] = ((tmp_key[5] << 2) | (tmp_key[6] >> 6)) & 0xfe;
    triple_des_key[7] = tmp_key[6] << 1;
    triple_des_key[8] = tmp_key[7] & 0xfe;
    triple_des_key[9] = ((tmp_key[7] << 7) | (tmp_key[8] >> 1)) & 0xfe;
    triple_des_key[10] = ((tmp_key[8] << 6) | (tmp_key[9] >> 2)) & 0xfe;
    triple_des_key[11] = ((tmp_key[9] << 5) | (tmp_key[10] >> 3)) & 0xfe;
    triple_des_key[12] = ((tmp_key[10] << 4) | (tmp_key[11] >> 4)) & 0xfe;
    triple_des_key[13] = ((tmp_key[11] << 3) | (tmp_key[12] >> 5)) & 0xfe;
    triple_des_key[14] = ((tmp_key[12] << 2) | (tmp_key[13] >> 6)) & 0xfe;
    triple_des_key[15] = tmp_key[13] << 1;

    for(int i = 0; i < 16; ++i)
        triple_des_key[i] = odd_parity[triple_des_key[i]];

    des_set_key(&triple_des_key[0], ks1);
    des_set_key(&triple_des_key[8], ks2);
} /* triple_des_set_key */
